# Infrastructure Plan - Rubber Duck Diaries

## Overview

This document outlines the Azure infrastructure required to run the Rubber Duck Diaries blog application, which consists of:

- **API**: .NET 8.0 ASP.NET Core Web API with Entity Framework Core
- **UI**: Angular SPA served via nginx
- **Database**: Azure SQL Server

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Azure Resource Group                              │
│                      (RG-RubberDuckDiaries)                             │
│                                                                          │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────┐  │
│  │   App Service   │    │   App Service   │    │  Azure Container    │  │
│  │   (UI - SPA)    │───▶│   (API)         │    │  Registry (ACR)     │  │
│  │   nginx:80      │    │   dotnet:80     │    │                     │  │
│  └────────┬────────┘    └────────┬────────┘    └─────────────────────┘  │
│           │                      │                        ▲              │
│           │                      │                        │              │
│           │                      ▼                        │              │
│           │             ┌─────────────────┐              │              │
│           │             │  Azure SQL      │     Docker Images           │
│           │             │  Database       │     - rubberduckdiaries-ui  │
│           │             │                 │     - rubberduckdiaries-api │
│           │             └─────────────────┘              │              │
│           │                      ▲                        │              │
│           │                      │                        │              │
│           │             ┌────────┴────────┐              │              │
│           │             │   Key Vault     │──────────────┘              │
│           └────────────▶│   (Secrets)     │                             │
│                         └─────────────────┘                             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                         ┌─────────────────┐
                         │  GitHub Actions │
                         │  (CI/CD)        │
                         └─────────────────┘
```

---

## Current Infrastructure Status

### ✅ Completed

| Resource | Name | Status | Notes |
|----------|------|--------|-------|
| Resource Group | `RG-RubberDuckDiaries` | ✅ Active | Location: australiaeast |
| Container Registry | `rubberduckdiariesacr` | ✅ Active | Basic SKU, admin enabled |
| Key Vault | `rubberduckdiaries-kv` | ✅ Active | Service Principal access configured |
| SQL Server | `rubberduckdiaries-sqlserver` | ✅ Active | v12.0, public access enabled |
| SQL Database | `RubberDuckDiariesDB` | ✅ Active | S0 SKU |
| KV Secret | `DbConnectionString` | ✅ Active | Auto-generated by SQL module |
| KV Secret | `SqlAdminPassword` | ✅ Active | Auto-generated by SQL module |

### ⏳ Pending / Commented Out

| Resource | Name | Status | Action Required |
|----------|------|--------|-----------------|
| App Service Plan | `rubberduckdiaries-plan` | ❌ Commented | Uncomment and fix module |
| App Service (UI) | `rubberduckdiaries-ui` | ❌ Commented | Uncomment and fix module |
| App Service (API) | `rubberduckdiaries-api` | ❌ Commented | Uncomment and fix module |

---

## Required Secrets

The API requires the following configuration (from `appsettings.json`):

| Secret Name | Purpose | Storage Location | Status |
|-------------|---------|------------------|--------|
| `CONNECTION_STRING` | SQL Database connection | Key Vault (`DbConnectionString`) | ✅ Auto-created |
| `TOKEN_KEY` | JWT signing key | GitHub Secrets / Key Vault | ⚠️ Manual setup |
| `ADMIN_USERNAME` | Initial admin account | GitHub Secrets | ⚠️ Manual setup |
| `ADMIN_EMAIL` | Initial admin email | GitHub Secrets | ⚠️ Manual setup |
| `ADMIN_PASSWORD` | Initial admin password | GitHub Secrets | ⚠️ Manual setup |
| `CLIENT_URL` | CORS allowed origin | GitHub Secrets | ⚠️ Manual setup |
| `API_URL` | API endpoint for UI | GitHub Secrets | ⚠️ Manual setup |
| `AZURE_CREDENTIALS` | Service Principal for CI/CD | GitHub Secrets | ⚠️ Manual setup |

---

## Issues to Fix

### 1. App Service Module Uses Deprecated Resources

**Current Issue**: The `modules/appservice/main.tf` uses deprecated Terraform resources:
- `azurerm_app_service_plan` → Should use `azurerm_service_plan`
- `azurerm_app_service` → Should use `azurerm_linux_web_app`

**Impact**: May fail with newer versions of the Azure provider.

### 2. Module Parameter Mismatch

**Current Issue**: The module calls in `main.tf` (commented out) pass different parameters than what the module expects.

**main.tf expects:**
```hcl
container_image     = "rubberduckdiariesacr.azurecr.io/rubberduckdiaries-ui:latest"
container_registry  = module.acr.login_server
registry_username   = module.acr.admin_username
registry_password   = module.acr.admin_password
```

**Module expects:**
```hcl
acr_name           = "rubberduckdiariesacr"
container_image    = "rubberduckdiaries-ui"
container_tag      = "latest"
```

### 3. Missing SQL Server Firewall Rules

**Current Issue**: No firewall rules configured for SQL Server.

**Required Rules:**
- Allow Azure Services (0.0.0.0 - 0.0.0.0)
- Optional: Developer IP addresses for debugging

### 4. Missing App Service Access to Key Vault

**Current Issue**: App Services need access policy to read secrets from Key Vault.

**Solution**: Add access policy for App Service managed identity.

### 5. Duplicate App Service Plan Creation

**Current Issue**: The appservice module creates its own plan, but main.tf also has a separate appserviceplan module.

**Solution**: Decide on one approach - either:
- Use shared plan from `appserviceplan` module
- Let each app service create its own plan

---

## Action Plan

### Phase 1: Fix Existing Modules ⚠️ Priority

#### Task 1.1: Update App Service Module to Use Modern Resources

Replace deprecated resources in `modules/appservice/main.tf`:

```hcl
# Replace azurerm_app_service_plan with azurerm_service_plan
# Replace azurerm_app_service with azurerm_linux_web_app
```

#### Task 1.2: Align Module Variables

Update `modules/appservice/variables.tf` to match what `main.tf` passes or vice versa.

#### Task 1.3: Add SQL Firewall Rules

Add to `modules/sql/main.tf`:

```hcl
resource "azurerm_mssql_firewall_rule" "allow_azure_services" {
  name             = "AllowAzureServices"
  server_id        = azurerm_mssql_server.sqlserver.id
  start_ip_address = "0.0.0.0"
  end_ip_address   = "0.0.0.0"
}
```

### Phase 2: Complete App Services

#### Task 2.1: Uncomment and Fix App Service Plan

```hcl
module "app_service_plan" {
  source              = "./modules/appserviceplan"
  resource_group_name = azurerm_resource_group.rg.name
  location            = azurerm_resource_group.rg.location
  plan_name           = "rubberduckdiaries-plan"
  sku_name            = "B1"  # Basic tier, suitable for small workloads
}
```

#### Task 2.2: Deploy API App Service

```hcl
module "api_app_service" {
  source              = "./modules/appservice"
  app_name            = "rubberduckdiaries-api"
  resource_group_name = azurerm_resource_group.rg.name
  location            = azurerm_resource_group.rg.location
  app_service_plan_id = module.app_service_plan.id
  acr_name            = module.acr.acr_login_server
  container_image     = "rubberduckdiaries-api"
  container_tag       = "latest"
  keyvault_id         = module.keyvault.keyvault_id
}
```

#### Task 2.3: Deploy UI App Service

```hcl
module "ui_app_service" {
  source              = "./modules/appservice"
  app_name            = "rubberduckdiaries-ui"
  resource_group_name = azurerm_resource_group.rg.name
  location            = azurerm_resource_group.rg.location
  app_service_plan_id = module.app_service_plan.id
  acr_name            = module.acr.acr_login_server
  container_image     = "rubberduckdiaries-ui"
  container_tag       = "latest"
  keyvault_id         = module.keyvault.keyvault_id
}
```

### Phase 3: Key Vault Integration

#### Task 3.1: Add Additional Secrets to Key Vault

Option A: Add via Terraform (for non-sensitive defaults):
```hcl
module "keyvault" {
  # ... existing config ...
  secrets = {
    "TokenKey" = "your-jwt-signing-key-here"  # Generate a secure key
  }
}
```

Option B: Add manually via Azure Portal or CLI (recommended for sensitive values)

#### Task 3.2: Grant App Service Access to Key Vault

Add to keyvault module or create new access policy:

```hcl
resource "azurerm_key_vault_access_policy" "app_service" {
  key_vault_id = azurerm_key_vault.keyvault.id
  tenant_id    = var.tenant_id
  object_id    = azurerm_linux_web_app.app.identity[0].principal_id

  secret_permissions = ["Get", "List"]
}
```

### Phase 4: GitHub Actions Configuration

#### Task 4.1: Configure GitHub Secrets

Required secrets in GitHub repository settings:

| Secret Name | Value |
|-------------|-------|
| `AZURE_CREDENTIALS` | Service Principal JSON |
| `CONNECTION_STRING` | From Key Vault `DbConnectionString` |
| `TOKEN_KEY` | Generate secure random string (64+ chars) |
| `ADMIN_USERNAME` | Your admin username |
| `ADMIN_EMAIL` | Your admin email |
| `ADMIN_PASSWORD` | Strong password |
| `CLIENT_URL` | `https://rubberduckdiaries-ui.azurewebsites.net` |
| `API_URL` | `https://rubberduckdiaries-api.azurewebsites.net` |

#### Task 4.2: Verify CI/CD Workflows

Existing workflows should work once secrets are configured:
- `.github/workflows/docker-publish.yml` - API builds
- `.github/workflows/docker-build-ui.yml` - UI builds

---

## Resource Costs Estimate (AUD/month)

| Resource | SKU | Estimated Cost |
|----------|-----|----------------|
| App Service Plan | B1 (shared for both apps) | ~$20-30 |
| Azure SQL Database | S0 | ~$20-25 |
| Container Registry | Basic | ~$7 |
| Key Vault | Standard | ~$0.03/10k operations |
| **Total** | | **~$50-65/month** |

---

## Deployment Order

1. ✅ Resource Group (done)
2. ✅ Key Vault (done) 
3. ✅ SQL Server + Database (done)
4. ✅ Container Registry (done)
5. ⏳ App Service Plan
6. ⏳ API App Service
7. ⏳ UI App Service
8. ⏳ Configure GitHub Secrets
9. ⏳ Run CI/CD pipelines to deploy containers

---

## Commands Reference

### Terraform

```bash
# Initialize Terraform
cd Infrastructure
terraform init

# Plan changes
terraform plan

# Apply changes
terraform apply

# Show current state
terraform show
```

### Azure CLI

```bash
# Login to Azure
az login

# Set subscription
az account set --subscription "your-subscription-id"

# Get Key Vault secrets
az keyvault secret show --vault-name rubberduckdiaries-kv --name DbConnectionString

# Test SQL connectivity
az sql db show-connection-string --server rubberduckdiaries-sqlserver --name RubberDuckDiariesDB --client ado.net
```

### Docker (Local Testing)

```bash
# Start local SQL Server
docker-compose up -d

# Build API
docker build -t rubberduckdiaries-api ./API

# Build UI  
docker build -t rubberduckdiaries-ui ./client
```

---

## Next Steps

1. [ ] Fix the App Service module to use modern Terraform resources
2. [ ] Add SQL Server firewall rules
3. [ ] Uncomment and deploy App Service Plan
4. [ ] Deploy API and UI App Services
5. [ ] Configure GitHub Secrets
6. [ ] Test end-to-end deployment
7. [ ] Configure custom domain (optional)
8. [ ] Set up SSL certificates (optional)

---

## References

- [Azure App Service Documentation](https://docs.microsoft.com/en-us/azure/app-service/)
- [Terraform AzureRM Provider](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
- [Azure Container Registry](https://docs.microsoft.com/en-us/azure/container-registry/)
- [Azure Key Vault](https://docs.microsoft.com/en-us/azure/key-vault/)
